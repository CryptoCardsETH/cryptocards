version: '3.2'

# Docker Services breakdown:
# db - mysql DB, used by backend
# nginx - webserver the backend, uses fpm as a backing
# fpm - is called by nginx to actually execute the php for the backendd
# frontend - runs React in dev mode with hot reloading 
# ethereum_proxy - go layer is called by the backend over gRPC, handles communicating with eth network
# truffle_test - ephemeral container that runs the truffle (contract) tests
# eth_rpc - container that runs the ganache CLI, truffle_test uses this as a local eth node
# codegen_tools - ephemeral container that generates the golang and php stubs based on RpcServer.proto

services:
  db:
    image: mysql:5.7
    volumes:
      - "./.data/db:/var/lib/mysql"
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: cryptocards 
    ports:
      - "3307:3306" #expose 3306 on a nonstandard port so that it doesn't conflict with mysql on the host
  nginx:
    image: nginx:latest
    ports:
        - "8728:8080"
    volumes:
        - ./backend:/var/www/laravel
    working_dir: /var/www/laravel
    links:
      - fpm
    volumes:
      - ./backend/vhost-docker.conf:/etc/nginx/conf.d/laravel.conf

  fpm:  
     build: ./backend
     ports:
         - "9000:9000"
     links: 
         - db
         - ethereum_proxy
     volumes:
         - ./backend/:/var/www/laravel
     working_dir: /var/www/laravel
     environment:
      DB_HOST: db
      DB_PORT: 3306
      DB_CONNECTION: mysql
      DB_DATABASE: cryptocards
      DB_USERNAME: root
      DB_PASSWORD: root
      RPC_SERVER_ADDRESS: ethereum_proxy:50051

  frontend:
    build: ./frontend
    volumes:
        - { type: bind, source: ./frontend, target: /app }
    environment:
      REACT_APP_API_BASE_URL: http://localhost:8728/v1
      REACT_APP_SITE_URL: http://localhost:5000
      PORT: 3000
    ports:
      - "5000:3000" #expose 3000 via 5000
      - "35729:35729" #for hot reloading
  ethereum_proxy:
    build: ./ethereum_proxy 
    volumes: 
      - { type: bind, source: ./ethereum_proxy, target: /go }
    environment:
      PORT: 50051
  truffle_test:
    build: ./eth_contracts
    volumes:
      - ./eth_contracts:/app
    environment:
      RPC_HOST: eth_rpc
      RPC_PORT: 8545
    links:
      - eth_rpc

  eth_rpc: 
    image: trufflesuite/ganache-cli:latest


  codegen_tools_proto:
    build: ./tools/proto
    volumes: 
      - { type: bind, source: ./backend, target: /backend }
      - { type: bind, source: ./ethereum_proxy, target: /ethereum_proxy }
      - { type: bind, source: ./tools, target: /tools }

  codegen_tools_abigen:
    build: ./tools/abigen
    volumes:
      - { type: bind, source: ./eth_contracts, target: /eth_contracts}
      - { type: bind, source: ./ethereum_proxy, target: /ethereum_proxy }
      - { type: bind, source: ./tools, target: /tools }

    
